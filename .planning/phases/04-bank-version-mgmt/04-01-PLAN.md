---
phase: 04-bank-version-mgmt
plan: 01
type: execute
depends_on: []
files_modified: [src/app/api/admin/versions/route.ts, src/app/api/admin/versions/[id]/route.ts, src/lib/utils.ts]
---

<objective>
Create CRUD API endpoints for bank version management with slug generation and validation.

Purpose: Enable admin to create, read, update, and deactivate bank-specific plan versions through validated API.
Output: Complete REST API for plan_versions table operations with slug utility.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
@.planning/phases/03-shared-config-mgmt/03-01-SUMMARY.md
@src/app/api/admin/config/route.ts
@src/lib/supabase.ts

**Tech stack available:** Next.js 14, TypeScript, Tailwind CSS, Supabase client
**Established patterns:**
- Simple Supabase client pattern (@supabase/supabase-js createClient, not SSR patterns)
- API validation pattern: required fields, type validation, range validation, field-specific error messages
- Error handling: 400 for validation, 404 for not found, 500 for server errors

**Constraining decisions:**
- Numeric types for all financial values (from 01-02)
- Slug-based bank identification for URL routing (from 01-02)
- Nullable override pattern: null = use plan_config default (from 01-02)
- Comprehensive API validation as source of truth (from 03-01)

**Database schema (plan_versions table):**
- id (uuid, primary key)
- bank_name (text, required)
- slug (text, unique, required) - URL-friendly identifier
- is_active (boolean, default true)
- line_of_credit_override (numeric, nullable)
- interest_rate_pct_override (numeric, nullable)
- total_head_override (integer, nullable)
- created_at, updated_at (timestamps)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bank version CRUD API routes</name>
  <files>src/app/api/admin/versions/route.ts, src/app/api/admin/versions/[id]/route.ts</files>
  <action>
Create two route files following the established config API pattern:

**File 1: src/app/api/admin/versions/route.ts**
- GET handler: Fetch all versions ordered by created_at DESC, return array of all fields
- POST handler: Create new version with validation:
  - Required: bank_name (string, min 1 char), slug (string, lowercase-hyphenated format)
  - Optional: line_of_credit_override (numeric, positive if provided), interest_rate_pct_override (numeric, 0-100 if provided), total_head_override (integer, positive if provided)
  - Validate slug uniqueness (check existing slugs before insert)
  - Validate slug format (lowercase, hyphens only, no spaces or special chars except hyphens)
  - Set is_active = true by default
  - Return created version object

**File 2: src/app/api/admin/versions/[id]/route.ts**
- PATCH handler: Update existing version
  - Accept same fields as POST (all optional for update)
  - Validate slug uniqueness if slug is being changed (exclude current record)
  - Return updated version object
- DELETE handler: Soft delete by setting is_active = false
  - Don't actually delete row, just update is_active
  - Return success message

**Validation requirements:**
- bank_name: required on POST, min 1 char, max 255 chars
- slug: required on POST, must match pattern /^[a-z0-9]+(?:-[a-z0-9]+)*$/ (lowercase alphanumeric with hyphens)
- Override fields: if provided, must be valid numbers (not NaN), positive for LOC and head count, 0-100 for interest rate
- Unique slug check: query existing versions, return 400 if duplicate found

**Error responses:**
- 400: Validation errors with specific field messages
- 404: Version ID not found
- 409: Slug conflict (already exists)
- 500: Database errors

Use established Supabase client pattern from config route. Follow same error handling structure.
  </action>
  <verify>
Test all endpoints:
- POST /api/admin/versions with valid data returns 201 with created object
- POST with duplicate slug returns 409
- POST with invalid slug format returns 400
- GET /api/admin/versions returns array of all versions
- PATCH /api/admin/versions/[id] updates and returns updated object
- DELETE /api/admin/versions/[id] sets is_active=false and returns success
  </verify>
  <done>All CRUD operations work, validation prevents invalid data, slugs are unique, soft delete preserves data</done>
</task>

<task type="auto">
  <name>Task 2: Add slug generation utility</name>
  <files>src/lib/utils.ts</files>
  <action>
Create src/lib/utils.ts with generateSlug function:

```typescript
export function generateSlug(text: string): string {
  return text
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '') // Remove special chars except spaces and hyphens
    .replace(/[\s_]+/g, '-')  // Replace spaces and underscores with hyphens
    .replace(/-+/g, '-')      // Replace multiple hyphens with single
    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
}
```

This function transforms "First National Bank" → "first-national-bank", handles edge cases like multiple spaces, special characters, and ensures clean hyphenated output.

Export this function for use in both API routes and UI forms.

Do NOT use external libraries (no slugify npm package) - keep it simple and dependency-free. The function above handles all necessary transformations for bank names.
  </action>
  <verify>
Import generateSlug in route.ts and test transformations:
- "First National Bank" → "first-national-bank"
- "Cameron State Bank" → "cameron-state-bank"
- "Community Bank & Trust" → "community-bank-trust"
- "Bank  of   America" → "bank-of-america" (handles multiple spaces)
  </verify>
  <done>generateSlug function exists, handles edge cases, produces valid slug format</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 4 HTTP methods (GET, POST, PATCH, DELETE) work correctly
- [ ] Validation prevents invalid data (bad slugs, negative numbers, out-of-range percentages)
- [ ] Slug uniqueness enforced at API level
- [ ] generateSlug utility produces consistent, valid slugs
- [ ] Soft delete preserves data (is_active flag works)
- [ ] Error responses follow established pattern (400/404/409/500 with messages)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- API routes follow established patterns from Phase 3
- No TypeScript errors
- Validation is comprehensive and matches database constraints
  </success_criteria>

<output>
After completion, create `.planning/phases/04-bank-version-mgmt/04-01-SUMMARY.md`:

# Phase 4 Plan 01: Bank Version API Summary

**REST API for CRUD operations on plan_versions with slug generation and comprehensive validation**

## Accomplishments

- [Key outcomes from implementation]

## Files Created/Modified

- [List all files with descriptions]

## Decisions Made

[Document any implementation decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 04-02-PLAN.md (Bank Version Admin UI)
</output>
