---
phase: 05-financial-calculations
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/20260210000001_expand_config_schema.sql, src/app/api/admin/config/route.ts, src/app/admin/config/page.tsx]
---

<objective>
Expand database schema to support detailed financial calculations with spring/winter turn separation and comprehensive cost tracking.

Purpose: Add the operational fields needed for accurate stocker cattle financial projections, matching the requirements documented in project.md
Output: Expanded plan_config schema with ~35 fields covering spring turn, winter turn, feed details, and scenario pricing
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
@.planning/phases/03-shared-config-mgmt/03-01-SUMMARY.md
@supabase/migrations/20260209000001_initial_schema.sql
@project.md

**Tech stack available:**
- Supabase PostgreSQL with numeric type for precision
- Next.js API routes with validation patterns
- React controlled forms with state management

**Established patterns:**
- Numeric type for all financial values (Phase 1)
- Comprehensive API validation with range checks (Phase 3)
- Controlled form inputs with section organization (Phase 3)
- Singleton pattern for plan_config (Phase 1)

**Constraining decisions:**
- Two-table design (plan_config + plan_versions) - only expand plan_config
- Nullable override pattern in plan_versions stays unchanged
- Numeric type (not float) for precision financial calculations
- API is source of truth for validation

**Requirements being addressed:**
From PROJECT.md:
- "Spring turn, winter turn, annual projections with scenario analysis"
- "Hay price sensitivity, purchase price sensitivity, breakeven calculations"
- "All financial projections derived from inputs (no hardcoded values)"

From project.md:
- Detailed calculation formulas for spring/winter turns
- Separate operational parameters for each turn
- Feed cost breakdowns (hay + commodity)
- Scenario pricing (low/mid/high sale prices)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and apply schema migration adding detailed operational fields</name>
  <files>supabase/migrations/20260210000001_expand_config_schema.sql, supabase/README.md</files>
  <action>
Create migration file adding fields to plan_config table. Follow project.md schema requirements but adapt to match implemented naming conventions (snake_case with _lbs, _pct, _per suffixes).

**Fields to add (organize by category in migration):**

**Operator Info (4 fields):**
- operator_name text DEFAULT 'Jason Pierce'
- operation_location text DEFAULT 'SE Kansas'
- acres integer DEFAULT 160
- years_experience integer DEFAULT 20

**Sale Scenarios (2 fields):**
- sale_price_low_per_cwt numeric NOT NULL
- sale_price_high_per_cwt numeric NOT NULL
(Keep existing market_price_500lb and market_price_850lb as base/mid prices)

**Spring Turn Operations (10 fields):**
- spring_sale_weight_lbs integer NOT NULL
- spring_days_on_feed integer NOT NULL
- spring_health_cost_per_head numeric NOT NULL
- spring_freight_in_per_head numeric NOT NULL
- spring_mineral_cost_per_head numeric NOT NULL
- spring_lrp_premium_per_head numeric NOT NULL
- spring_marketing_commission_per_head numeric NOT NULL
- spring_freight_out_per_head numeric NOT NULL
- spring_death_loss_pct numeric NOT NULL
- spring_misc_per_head numeric NOT NULL

**Winter Turn Operations (10 fields):**
- winter_sale_weight_lbs integer NOT NULL
- winter_days_on_feed integer NOT NULL
- winter_health_cost_per_head numeric NOT NULL
- winter_freight_in_per_head numeric NOT NULL
- winter_mineral_cost_per_head numeric NOT NULL
- winter_lrp_premium_per_head numeric NOT NULL
- winter_marketing_commission_per_head numeric NOT NULL
- winter_freight_out_per_head numeric NOT NULL
- winter_death_loss_pct numeric NOT NULL
- winter_misc_per_head numeric NOT NULL

**Winter Feed Details (6 fields):**
- hay_price_per_bale numeric NOT NULL
- hay_bale_weight_lbs integer NOT NULL
- hay_daily_intake_lbs numeric NOT NULL
- hay_waste_pct numeric NOT NULL
- commodity_price_per_ton numeric NOT NULL
- commodity_daily_intake_lbs numeric NOT NULL

**Migration structure:**
```sql
ALTER TABLE plan_config
  ADD COLUMN operator_name text DEFAULT 'Jason Pierce',
  ADD COLUMN operation_location text DEFAULT 'SE Kansas',
  ... (all fields)

-- Update existing row with sensible defaults from project.md seed data
UPDATE plan_config SET
  operator_name = 'Jason Pierce',
  operation_location = 'SE Kansas',
  ... (all fields with defaults)
WHERE id = (SELECT id FROM plan_config LIMIT 1);
```

**What to avoid:**
- Don't use FLOAT type (use numeric for precision) - Phase 1 established this pattern
- Don't add constraints that conflict with existing singleton pattern
- Don't remove or rename existing fields (market_price_500lb, market_price_850lb, etc.) - backward compatibility

**Deployment:** Update supabase/README.md with instructions to apply this migration via SQL editor, similar to initial schema deployment pattern from Phase 1.
  </action>
  <verify>
Migration file has valid PostgreSQL syntax (no syntax errors when running locally or in SQL editor preview).
All numeric fields defined, all defaults set, UPDATE statement updates existing singleton row.
README updated with deployment instructions.
  </verify>
  <done>
Migration file created with ~35 new fields organized by category.
UPDATE statement populates existing plan_config row with defaults from project.md.
README.md includes deployment instructions matching Phase 1 pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update config API and admin form to handle new fields</name>
  <files>src/app/api/admin/config/route.ts, src/app/admin/config/page.tsx</files>
  <action>
Update GET and PUT endpoints in config API route to include all new fields.

**API route changes (src/app/api/admin/config/route.ts):**

GET endpoint: No changes needed (SELECT * will automatically include new fields)

PUT endpoint validation additions:
- Operator info: operator_name (string 1-255), operation_location (string 1-255), acres (integer > 0), years_experience (integer >= 0)
- Sale scenarios: sale_price_low_per_cwt (numeric > 0), sale_price_high_per_cwt (numeric > 0)
- Spring turn: All 10 spring_* fields (numeric > 0 for costs, integer > 0 for weights/days, 0-100 for death_loss_pct)
- Winter turn: All 10 winter_* fields (same validation as spring)
- Winter feed: All 6 feed fields (numeric > 0, integer > 0 for bale weight, 0-100 for waste_pct)

Follow Phase 3 validation pattern: type checking, positive value requirements, percentage ranges.

**Admin form changes (src/app/admin/config/page.tsx):**

Expand form sections from 4 to 8 sections:
1. **Operator Information** - 4 fields (name, location, acres, years)
2. **Market Prices** - Existing 2 fields PLUS sale_price_low_per_cwt and sale_price_high_per_cwt (rename section to "Market Prices & Scenarios")
3. **Feed Costs** - Keep existing 2 fields
4. **Operational Parameters** - Keep existing 4 fields (purchase/sale weights, ADG, mortality)
5. **Spring Turn Costs** - New section with 10 spring_* fields organized in grid
6. **Winter Turn Costs** - New section with 10 winter_* fields organized in grid
7. **Winter Feed Details** - New section with 6 hay/commodity fields
8. **Financial Defaults** - Keep existing 3 fields (interest_rate_pct, loc_amount, head_count)

**Form organization:**
- Group related fields in 2-column grid within each section (matching Phase 3 pattern)
- Add appropriate labels with units ($, lbs, days, %)
- Use same controlled input pattern with formData state
- Extend validation to include all new fields (matching API validation)
- Keep cancel/submit behavior, loading states, error messaging

**What to avoid:**
- Don't change existing field names in API or form (maintain backward compatibility)
- Don't skip validation for any numeric field (API must validate comprehensively)
- Don't make the form overwhelming - use clear section headers and logical grouping
- Don't hardcode any calculation logic in the form (this is pure CRUD - calculations come in Plan 05-02)
  </action>
  <verify>
API PUT endpoint accepts all 46 fields (11 original + 35 new) with proper validation.
API returns 400 with field-specific errors for invalid inputs.
Form displays all 8 sections with organized field layout.
Form submits successfully and updates database.
No TypeScript errors, form state management works correctly.
  </verify>
  <done>
API route validates all 46 plan_config fields with type and range checks.
Admin form has 8 organized sections displaying all fields.
Form successfully loads, edits, and saves expanded config data.
No errors, validation works, UI remains professional and organized.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file has valid SQL syntax
- [ ] Migration successfully adds all new columns to plan_config
- [ ] Existing plan_config row updated with defaults
- [ ] API GET returns all 46 fields
- [ ] API PUT validates all 46 fields
- [ ] Admin form displays all 8 sections with proper organization
- [ ] Form saves successfully and updates database
- [ ] No TypeScript errors or console warnings
</verification>

<success_criteria>

- All tasks completed
- Schema expanded with ~35 new fields organized by category
- Migration applied to Supabase database
- API route handles all fields with comprehensive validation
- Admin form provides organized interface for all parameters
- Existing functionality (original 11 fields) still works
- No breaking changes to plan_versions table or existing APIs
- Ready for Plan 05-02 (calculation engine can now access all needed data)
</success_criteria>

<output>
After completion, create `.planning/phases/05-financial-calculations/05-01-SUMMARY.md`:

# Phase 5 Plan 01: Schema Migration & Config API Updates Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `supabase/migrations/20260210000001_expand_config_schema.sql` - Description
- `src/app/api/admin/config/route.ts` - Description
- `src/app/admin/config/page.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-02-PLAN.md (Calculation Engine Core)
</output>
