---
phase: 01-foundation-database
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [supabase/migrations/20260209000001_initial_schema.sql, supabase/seed.sql]
domain: next-js
---

<objective>
Deploy database schema for plan_config (shared financials) and plan_versions (bank-specific overrides) with seed data.

Purpose: Create the two-table structure that enables single-source-of-truth for shared operational data with per-bank customization.
Output: Working database schema with realistic seed data for development and testing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-database/01-01-SUMMARY.md

**Database Design (from PROJECT.md):**
- Two-table schema: plan_config for shared data, plan_versions for bank-specific overrides
- Calculation precision required (all dollar amounts must trace back to config)
- Schema already designed (implement according to requirements)

**Required Tables:**
1. **plan_config** — Single row with shared operational/financial inputs
2. **plan_versions** — Multiple rows, one per bank, with optional overrides
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plan_config table schema</name>
  <files>supabase/migrations/20260209000001_initial_schema.sql</files>
  <action>Create Supabase migration file with plan_config table. This is the single source of truth for shared operational and financial data. Include fields: id (uuid primary key, default gen_random_uuid()), created_at (timestamptz default now()), updated_at (timestamptz default now()),

Market prices: market_price_500lb (numeric), market_price_850lb (numeric),

Feed costs: hay_price_per_ton (numeric), feed_cost_per_day (numeric),

Operational params: purchase_weight_lbs (integer), sale_weight_lbs (integer), avg_daily_gain_lbs (numeric), mortality_rate_pct (numeric),

Financial defaults: interest_rate_pct (numeric), loc_amount (numeric), head_count (integer).

Use numeric type for precision (not float). Add updated_at trigger to auto-update on modifications. Add constraint to ensure only one row exists (singleton pattern): `CHECK (id = gen_random_uuid())` is wrong - instead use `CREATE UNIQUE INDEX ON plan_config ((1))` to enforce single row.</action>
  <verify>Migration file exists, SQL is valid PostgreSQL syntax, includes all required fields with correct types</verify>
  <done>plan_config table defined with all shared operational and financial parameters, single-row constraint enforced</done>
</task>

<task type="auto">
  <name>Task 2: Create plan_versions table schema</name>
  <files>supabase/migrations/20260209000001_initial_schema.sql</files>
  <action>In the same migration file, add plan_versions table for bank-specific plans. Include fields: id (uuid primary key, default gen_random_uuid()), created_at (timestamptz default now()), updated_at (timestamptz default now()), slug (text unique not null - URL identifier like 'cameron' or 'first-national'), bank_name (text not null), is_active (boolean default true), override_loc_amount (numeric nullable - overrides plan_config if set), override_interest_rate_pct (numeric nullable), override_head_count (integer nullable). Add updated_at trigger. Add index on slug for fast lookups. Override fields are nullable - null means use value from plan_config.</action>
  <verify>Migration file includes plan_versions table with slug uniqueness, nullable override fields, indexes</verify>
  <done>plan_versions table defined with bank identification, slug routing, and optional override mechanism</done>
</task>

<task type="auto">
  <name>Task 3: Deploy schema and add seed data</name>
  <files>supabase/seed.sql</files>
  <action>Apply migration to Supabase: `npx supabase db push`. Create seed.sql with realistic data: INSERT one row into plan_config with current market estimates (500lb price ~$280, 850lb price ~$235, hay ~$130/ton, feed ~$3.50/day, purchase weight 500lb, sale weight 850lb, ADG 2.5lb, mortality 1.5%, interest 7.5%, default LOC $500k, default head count 200). INSERT 2-3 sample banks into plan_versions: one using all defaults (slug: 'cameron', bank_name: 'Cameron State Bank', all overrides null), one with custom LOC (slug: 'first-national', bank_name: 'First National Bank', override_loc_amount: 750000), one inactive for testing (is_active: false). Run seed with `npx supabase db reset` (applies migrations + seed). Verify data in Supabase dashboard.</action>
  <verify>npx supabase db reset succeeds, plan_config has 1 row, plan_versions has 3 rows, data visible in Supabase Table Editor</verify>
  <done>Database schema deployed to Supabase, seed data loaded, ready for application queries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file applies without errors
- [ ] plan_config table exists with exactly 1 row
- [ ] plan_versions table exists with 3 sample rows
- [ ] Slug uniqueness enforced (try inserting duplicate slug - should fail)
- [ ] Override nullability works (at least one bank has null overrides)
- [ ] Timestamps auto-populate (created_at, updated_at)
- [ ] Data queryable via Supabase client in Next.js app
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Database schema deployed
- Seed data loaded
- Both tables functional and queryable
- Phase 1 complete - ready for Phase 2 (Admin Authentication & Layout)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database/01-02-SUMMARY.md`:

# Phase 1 Plan 02: Database Schema & Seed Data Summary

**Database schema deployed with two-table design and realistic seed data**

## Accomplishments

- Created plan_config table (singleton for shared operational/financial data)
- Created plan_versions table (bank-specific plans with override mechanism)
- Deployed schema to Supabase via migrations
- Loaded seed data (1 config row, 3 sample banks)
- Verified schema constraints and data integrity

## Files Created/Modified

- `supabase/migrations/20260209000001_initial_schema.sql` - Complete schema with both tables
- `supabase/seed.sql` - Realistic seed data for development

## Decisions Made

[Document schema adjustments, field naming choices, or seed data selections]

## Issues Encountered

[Any migration issues, constraint problems, or resolutions - or "None"]

## Next Phase Readiness

**Phase 1 Complete - Ready for Phase 2**: Admin Authentication & Layout
- Database foundation established
- Sample data available for UI development
- Next.js + Supabase stack confirmed working
- Ready to build admin dashboard with password protection
</output>
