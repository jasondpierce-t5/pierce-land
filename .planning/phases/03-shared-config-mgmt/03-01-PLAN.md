---
phase: 03-shared-config-mgmt
plan: 01
type: execute
depends_on: []
files_modified: [src/app/api/admin/config/route.ts, src/app/admin/config/page.tsx]
---

<objective>
Create admin interface to edit the plan_config table's singleton row.

Purpose: Provide a professional form interface for updating shared operational and financial parameters (market prices, feed costs, weights, mortality, financial defaults) that drive all bank-specific plan calculations.

Output: Working admin page at /admin/config with form to edit all 11 plan_config fields, organized by category with validation and success/error feedback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work
@.planning/phases/01-foundation-database/01-02-SUMMARY.md
@.planning/phases/02-admin-auth/02-01-SUMMARY.md

# Current codebase
@supabase/migrations/20260209000001_initial_schema.sql
@src/lib/supabase.ts
@src/app/api/admin/auth/route.ts
@src/app/admin/layout.tsx

**Tech stack available:**
- Next.js 14 App Router with TypeScript
- Supabase client (@supabase/supabase-js, simple createClient pattern)
- Tailwind CSS with brand colors (bg-primary #1a3a2a, text-accent #c4872a)
- Middleware-based auth protecting /admin/* routes

**Established patterns:**
- API routes: NextRequest/NextResponse, try/catch error handling, NextResponse.json()
- Supabase queries: `supabase.from('table_name').select()` and `.update()`
- Admin layout: Navigation already has link to /admin/config
- Singleton pattern: plan_config table has exactly one row (UNIQUE INDEX on (1))

**Constraining decisions:**
- Phase 1.2: Numeric type for all financial values (not float) for precision
- Phase 1.2: Singleton pattern enforced at database level
- Phase 2.1: Simple password auth, httpOnly cookies, middleware protection

**Database schema (plan_config table):**
11 fields organized as:
- Market prices (numeric): market_price_500lb, market_price_850lb
- Feed costs (numeric): hay_price_per_ton, feed_cost_per_day
- Operational params: purchase_weight_lbs (int), sale_weight_lbs (int), avg_daily_gain_lbs (numeric), mortality_rate_pct (numeric)
- Financial defaults (numeric): interest_rate_pct, loc_amount, head_count (int)

**Important:** Supabase migrations from Phase 1 must be applied before executing this plan (plan_config table must exist).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config API routes</name>
  <files>src/app/api/admin/config/route.ts</files>
  <action>
Create Next.js 14 API route with GET and PUT methods.

**GET method:**
- Query `supabase.from('plan_config').select('*').single()`
- Return the singleton row (should always exist from seed data)
- Handle case where no row exists (return 404 with clear message)
- Error handling: try/catch returning 500 on failure

**PUT method:**
- Accept JSON body with all 11 fields
- Validate: all required fields present, numeric fields are numbers, integers are whole numbers
- Update using `supabase.from('plan_config').update(data).eq('id', id)` (singleton row)
- Alternative: Since singleton, can use `.update(data).single()` without WHERE clause
- Return updated row on success
- Return 400 on validation errors with field-specific messages
- Return 500 on database errors

**Pattern to follow:** Match src/app/api/admin/auth/route.ts structure (NextRequest/NextResponse, try/catch, appropriate status codes)

**What to avoid:** Using .upsert() - the singleton row should already exist from migrations. Use .update() only. Don't use float for numeric fields when parsing JSON (convert to string or use numeric precision).
  </action>
  <verify>
Manual test with curl:
- GET: `curl http://localhost:3000/api/admin/config` returns 200 with config object
- PUT: `curl -X PUT http://localhost:3000/api/admin/config -H "Content-Type: application/json" -d '{"market_price_500lb": 280, ...}'` returns 200 with updated object
  </verify>
  <done>
- GET returns singleton config row with all 11 fields
- PUT validates required fields and types
- PUT updates database and returns updated row
- Error cases return appropriate status codes (400, 404, 500)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin config page with form</name>
  <files>src/app/admin/config/page.tsx</files>
  <action>
Create client component ('use client') at /admin/config with config edit form.

**Page structure:**
- Fetch current config on mount using GET /api/admin/config
- Display loading state while fetching
- Form with 4 sections (use fieldset/legend or section headers):
  1. **Market Prices (per cwt)**: market_price_500lb, market_price_850lb
  2. **Feed Costs**: hay_price_per_ton ($/ton), feed_cost_per_day ($/head/day)
  3. **Operational Parameters**: purchase_weight_lbs, sale_weight_lbs, avg_daily_gain_lbs, mortality_rate_pct (%)
  4. **Financial Defaults**: interest_rate_pct (%), loc_amount ($), head_count

**Form implementation:**
- React state for form data (useState with initial values from API)
- Controlled inputs (value={formData.field} onChange={handleChange})
- Input types: number for all numeric fields, step="0.01" for decimals, step="1" for integers
- Labels with units (e.g., "Purchase Weight (lbs)", "Mortality Rate (%)", "Line of Credit ($)")
- Submit button with loading state (disabled during submission)
- Cancel/Reset button to revert to current saved values

**Validation:**
- Client-side: Required fields, positive numbers, reasonable ranges (e.g., weights 100-2000 lbs, mortality 0-100%)
- Display validation errors inline below each field
- Disable submit if validation fails

**Submission:**
- PUT to /api/admin/config with form data
- Show loading state during request
- On success: Display success message ("Configuration updated successfully"), update local state with response
- On error: Display error message with details from API response
- Use toast/alert or inline message area at top of form

**Styling:**
- Match admin layout design (Tailwind, brand colors)
- Professional form layout: labels above inputs, grouped sections, clear spacing
- Inputs: border, padding, focus states (focus:ring-accent)
- Submit button: bg-primary text-white hover:bg-primary/90
- Cancel button: bg-gray-300 text-gray-700 hover:bg-gray-400

**What to avoid:**
- Don't use uncontrolled inputs (no refs, use controlled inputs with state)
- Don't submit without validation
- Don't use global state libraries (useState is sufficient for this form)
- Don't hardcode form values (fetch from API)
  </action>
  <verify>
Manual verification:
- Visit http://localhost:3000/admin/config (after logging in)
- Form displays current config values in organized sections
- Edit fields and submit - success message appears
- Refresh page - updated values persist
- Test validation: enter invalid values (negative numbers, empty fields) - errors appear
- Cancel button resets form to saved state
  </verify>
  <done>
- Page loads current config from API
- Form displays 11 fields organized in 4 sections with clear labels and units
- Client-side validation prevents invalid submissions
- Form submission updates database via PUT API
- Success/error messages displayed clearly
- Form is visually consistent with admin dashboard design
- Cancel button works
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] GET /api/admin/config returns singleton config row
- [ ] PUT /api/admin/config updates config and returns updated row
- [ ] /admin/config page loads without errors
- [ ] Form displays all 11 fields with current values
- [ ] Form submission updates database and shows success message
- [ ] Validation prevents invalid data submission
- [ ] Page navigation from admin dashboard works (click "Shared Config" link)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Config CRUD works end-to-end
- Professional UI matches admin dashboard design
- Phase 3 complete, ready for Phase 4 (Bank Version Management)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-shared-config-mgmt/03-01-SUMMARY.md`:

# Phase 3 Plan 01: Shared Config CRUD Interface Summary

**Admin interface for editing operational and financial parameters with organized form layout, validation, and real-time feedback**

## Accomplishments

- API routes for fetching and updating plan_config singleton row
- Admin config page with 11-field form organized in 4 sections
- Client-side validation for all numeric inputs
- Success/error messaging for form submissions
- Professional form design matching admin dashboard

## Files Created/Modified

- `src/app/api/admin/config/route.ts` - GET and PUT endpoints for config
- `src/app/admin/config/page.tsx` - Config edit form page

## Decisions Made

[Document any decisions made during implementation]

## Issues Encountered

[Document any problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3 complete. Ready for Phase 4: Bank Version Management.
</output>
