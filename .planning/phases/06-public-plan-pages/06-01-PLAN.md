---
phase: 06-public-plan-pages
plan: 01
type: execute
---

<objective>
Create the public plan page foundation: data fetching from Supabase, calculation pipeline, number formatting utilities, and page shell with cover header and KPI summary row.

Purpose: Establish the data-to-display pipeline so subsequent plans can focus purely on rendering business plan sections.
Output: Working /plan/[slug] route that fetches data, runs calculations, and displays a professional header with key financial highlights.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/types.ts
@src/lib/calculations.ts
@src/lib/supabase.ts
@src/app/layout.tsx
@middleware.ts

**Tech stack available:** Next.js 14 App Router, TypeScript, Tailwind CSS, Supabase, @supabase/supabase-js

**Established patterns:** Client components with API fetch, Supabase anon key client, branded Tailwind colors (primary #1a3a2a, accent #c4872a, green #3a7d53), Inter font

**Constraining decisions:**
- Simple Supabase client (not SSR patterns) — from 01-01
- Numeric type for financial precision — from 01-02
- No rounding at calculation level, consumers decide display precision — from 05-02
- Division-by-zero guards already in calculations — from 05-02
- Middleware only protects /admin/* — public routes are open
- RLS: plan_versions public SELECT only if is_active = true
- RLS: plan_config public SELECT on all
- mergeConfig(config, version) applies version overrides to base config — from 05-02
- Sensitivity defaults: hay $40-$80/bale, purchase +/-$0.20/lb — from 05-03
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create number formatting utilities and public data fetching function</name>
  <files>src/lib/formatters.ts</files>
  <action>
Create a formatters utility module with these functions:

**Number formatters:**
- formatCurrency(value: number): string — USD with commas, 2 decimals (e.g., "$1,234.56"). Negative values in accounting format: "($1,234.56)".
- formatCurrencyWhole(value: number): string — USD with commas, no decimals (e.g., "$1,235"). Accounting format for negatives.
- formatPercent(value: number, decimals = 1): string — Percentage with specified decimals (e.g., "4.5%"). Input is already in percentage form (not decimal).
- formatNumber(value: number, decimals = 0): string — Number with commas and specified decimals.
- formatWeight(value: number): string — Pounds with commas (e.g., "1,250 lbs").
- formatCwt(value: number): string — Price per cwt (e.g., "$185.00/cwt").

All formatters must handle NaN/Infinity/undefined gracefully by returning "N/A".

**Data fetching function (in separate src/lib/plan-data.ts):**
Create fetchPlanData(slug: string) async function that:
1. Queries plan_versions by slug using supabase.from('plan_versions').select('*').eq('slug', slug).eq('is_active', true).single()
2. Queries plan_config using supabase.from('plan_config').select('*').single()
3. If version not found (error or null), returns null (caller handles 404)
4. If config not found, throws descriptive error
5. Calls mergeConfig(config, version) from calculations.ts
6. Runs ALL calculation functions with merged config:
   - calculateSpringTurn(merged)
   - calculateWinterTurn(merged)
   - calculateAnnualProjections(spring, winter, merged)
   - calculateScenarios(merged)
   - calculateHaySensitivity(merged)
   - calculatePurchaseSensitivity(merged)
   - calculateWorstCase(merged)
   - getBreakevenPrices(spring, winter, merged)
7. Returns a typed PlanPageData object with: version, config (merged), spring, winter, annual, scenarios, haySensitivity, purchaseSensitivity, worstCase, breakeven

Export the PlanPageData type for use by the page component.
Import types from types.ts and calculation functions from calculations.ts.
Do NOT create a separate API route — this function will be called directly from the server component.
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>formatters.ts exports all formatting functions handling edge cases. plan-data.ts exports fetchPlanData returning complete typed calculation results or null.</done>
</task>

<task type="auto">
  <name>Task 2: Create /plan/[slug] dynamic route with cover header and KPI row</name>
  <files>src/app/plan/[slug]/page.tsx</files>
  <action>
Create a Next.js App Router server component at src/app/plan/[slug]/page.tsx.

**Data fetching:**
- Extract slug from params
- Call fetchPlanData(slug) from plan-data.ts
- If null returned, call notFound() from next/navigation
- Add generateMetadata() for dynamic page title: "{bank_name} | Pierce Land &amp; Cattle Business Plan"

**Page layout (server component — no 'use client'):**
- Full-width page with white background
- Max-width container (max-w-5xl mx-auto) with horizontal padding

**Cover Header section:**
- Full-width div with bg-primary (#1a3a2a) text-white
- "PIERCE LAND &amp; CATTLE" — text-3xl font-bold tracking-wide
- "Stocker Heifer Business Plan" — text-xl mt-1 text-white/80
- Divider line (border-t border-white/20 my-4)
- Bottom row with: "Prepared for: {bank_name}" on left, formatted current date (e.g., "February 2026") on right
- Below: "{operator_name} | {operation_location}" in text-white/70
- Padding: py-10 px-8

**KPI Summary Row (below header):**
- Grid of 5 cards: grid grid-cols-2 md:grid-cols-5 gap-4, with mt-8
- Each card: white bg, shadow-sm, rounded-lg, p-4, border-l-4 border-accent
- Card layout: label (text-xs text-gray-500 uppercase tracking-wide) on top, value (text-xl font-bold text-gray-900) below
- KPIs:
  1. "Annual Net Income" → annual.annualNetIncome (formatCurrencyWhole)
  2. "Head Count" → config.head_count (formatNumber)
  3. "LOC Utilization" → annual.locUtilization (formatPercent)
  4. "Spring Net/Head" → spring.netIncome (formatCurrency)
  5. "Winter Net/Head" → winter.netIncome (formatCurrency)
- Color net income values: green text if positive, red if negative

**Below KPI row:** Add a placeholder comment {/* Business plan sections added by Plan 06-02 and 06-03 */} — this is where subsequent plans will add sections.

Structure the page with clear section containers and consistent spacing (space-y-8) so Plan 06-02 can easily add sections.
  </action>
  <verify>Run npm run build — should compile without errors. Start dev server (npm run dev) and visit /plan/[existing-slug] — should see branded header and KPI cards with real calculated data. Visit /plan/nonexistent — should show 404 page.</verify>
  <done>Dynamic /plan/[slug] route renders professional cover header with bank name/operator info and KPI row with 5 formatted financial highlights. Invalid/inactive slugs return 404.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] /plan/[valid-slug] renders with real data from Supabase
- [ ] /plan/invalid-slug shows 404 page
- [ ] KPI values are properly formatted (currency, percentages)
- [ ] Cover header displays bank name, operator info, date
- [ ] No TypeScript errors (npx tsc --noEmit)
</verification>

<success_criteria>
- fetchPlanData function returns complete calculation results for valid slugs
- All formatters handle edge cases (NaN, Infinity, undefined)
- Dynamic route works with real slugs from database
- Professional header with branded colors (primary bg, white text)
- KPI row displays 5 key metrics with proper formatting
</success_criteria>

<output>
After completion, create `.planning/phases/06-public-plan-pages/06-01-SUMMARY.md`
</output>
