---
phase: 14-post-v11-formalization
plan: 01
type: execute
depends_on: []
files_modified: [.planning/PROJECT.md, .planning/STATE.md]
---

<objective>
Verify and formally document the sell/buy marketing model, spring feed costs, calculation corrections, and build stability fixes that shipped after v1.1 but before v1.2 milestone creation.

Purpose: These 6 commits (43c6a07, d4db07c, 7c6b22e, a263852, 754a05c, 302d827) represent significant feature work and infrastructure fixes that were developed outside the GSD planning system. Formalizing them ensures PROJECT.md accurately reflects shipped state, decisions are tracked, and the v1.2 milestone has a clean baseline.
Output: Verified features, updated PROJECT.md with validated requirements and key decisions, updated STATE.md.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files to verify:
@src/lib/calculations.ts
@src/lib/types.ts
@src/app/plan/[slug]/page.tsx
@src/app/admin/config/page.tsx
@src/lib/supabase.ts
@supabase/migrations/20260211000001_spring_feed_and_sell_buy.sql

# Prior context:
@.planning/phases/13-bank-version-management-ux/13-01-SUMMARY.md

**Post-v1.1 commits to formalize:**
1. `43c6a07` feat: add sell/buy marketing model and spring feed costs (11 files, 870+/263- lines)
2. `d4db07c` fix: correct credit utilization, scenario chart scale, cost of gain unit (3 files)
3. `7c6b22e` fix: disable Next.js fetch cache for Supabase queries
4. `a263852` fix: add force-dynamic to API routes for Vercel build
5. `754a05c` fix: move cache bypass from Supabase client to route-level dynamic export
6. `302d827` fix: lazy-init Supabase client to prevent Vercel build failure

**Constraining decisions:** Browser print-to-PDF, two-table schema, pure TypeScript calc engine (all from v1.0/v1.1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify post-v1.1 features and build stability</name>
  <files>src/lib/calculations.ts, src/lib/types.ts, src/app/plan/[slug]/page.tsx, src/app/admin/config/page.tsx, src/lib/supabase.ts, src/app/api/admin/config/route.ts, src/app/api/admin/versions/route.ts, src/app/api/admin/versions/[id]/route.ts</files>
  <action>
Verify all 6 post-v1.1 commits are functioning correctly:

**Sell/buy marketing model:**
- Confirm `calculateSellBuy()` exists in calculations.ts with correct logic: totalGrossRevenue × marginPct = protectedMargin, remainder = reinvestmentPool, nextHeadCount = floor(reinvestmentPool / purchaseCostPerHead)
- Confirm `SellBuyResult` type exists in types.ts with fields: headCount, totalGrossRevenue, protectedMargin, reinvestmentPool, purchaseCostPerHead, nextHeadCount
- Confirm SellBuy section renders on plan page with spring/winter breakdown
- Confirm sell_buy_margin_pct field exists in admin config

**Spring feed costs:**
- Confirm spring-specific intake rates (spring_hay_daily_intake_lbs, spring_commodity_daily_intake_lbs) are separate from winter rates
- Confirm TurnResult type has unified feed breakdown (hayPricePerLb, hayConsumed, hayCost, hayWaste, commodityCost, totalFeedCost)
- Confirm admin config Feed Details section has Shared Pricing + Spring Intake + Winter Intake subsections

**Calculation corrections:**
- Confirm capital required uses max(springDraw, winterDraw) not sum (sequential turns)
- Confirm scenario chart uses per-head values (Annual Net/Head)
- Confirm cost of gain displays as $/lb not $/cwt

**Build stability:**
- Confirm supabase.ts uses lazy-init Proxy pattern (not eager createClient at import time)
- Confirm all 3 API routes have `export const dynamic = 'force-dynamic'`
- Confirm plan page has `export const dynamic = 'force-dynamic'`
- Run `npm run build` — must pass with no errors

**Supabase migration:**
- Confirm migration file exists with 3 new columns: spring_hay_daily_intake_lbs, spring_commodity_daily_intake_lbs, sell_buy_margin_pct
  </action>
  <verify>npm run build succeeds with no errors. All feature points confirmed present in source code.</verify>
  <done>Build passes. Sell/buy marketing, spring feed costs, calculation corrections, and build stability verified in source code.</done>
</task>

<task type="auto">
  <name>Task 2: Update PROJECT.md with validated features and decisions</name>
  <files>.planning/PROJECT.md</files>
  <action>
Update PROJECT.md to reflect all post-v1.1 shipped work:

**Add to Validated requirements (after the v1.1 items):**
- ✓ Sell/buy marketing model — 25% protected margin at each sale, reinvestment into lighter replacement cattle, winter head count derived from spring proceeds — post-v1.1
- ✓ Spring feed costs — Spring-specific hay/commodity daily intake rates with shared pricing, unified TurnResult feed breakdown — post-v1.1
- ✓ Build stability — Lazy-init Supabase client, force-dynamic route exports, route-level cache bypass — post-v1.1

**Add to Key Decisions table:**
- "Sell/buy marketing with 25% default margin" | "Mirrors real cattle marketing — sell high, buy lighter replacements, keep margin" | "Good — produces realistic winter head counts"
- "Sequential turn capital (max not sum)" | "Spring and winter turns never overlap — LOC draw is peak of either, not both" | "Good — accurate credit utilization"
- "Lazy-init Supabase with Proxy" | "createClient at import time crashes Vercel build when env vars unavailable during page collection" | "Good — build passes reliably"
- "force-dynamic on data routes" | "Next.js 14 prerendering with Supabase causes stale data; force-dynamic ensures fresh queries" | "Good — eliminates stale cache bugs"

**Update Current state line in Context section:**
- Update line count, file count if significantly changed (check with `find src -name '*.ts' -o -name '*.tsx' -o -name '*.css' | xargs wc -l` and `find src -name '*.ts' -o -name '*.tsx' -o -name '*.css' | wc -l`)
- Add Supabase migrations to tech stack mention if not present

Do NOT modify any source code files. This task only modifies .planning/PROJECT.md.
  </action>
  <verify>PROJECT.md contains all post-v1.1 features in Validated section and all new decisions in Key Decisions table. No source code modified.</verify>
  <done>PROJECT.md accurately reflects complete shipped state including sell/buy marketing, spring feed costs, calculation corrections, and build stability.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` passes with no errors
- [ ] PROJECT.md Validated section includes sell/buy marketing, spring feed costs, build stability
- [ ] PROJECT.md Key Decisions table includes 4 new decisions
- [ ] No source code files were modified
</verification>

<success_criteria>

- All post-v1.1 features verified functional
- PROJECT.md updated with validated requirements and key decisions
- Build passes cleanly
- Phase 14 formally tracks the 6 previously-untracked commits
  </success_criteria>

<output>
After completion, create `.planning/phases/14-post-v11-formalization/14-01-SUMMARY.md`
</output>
